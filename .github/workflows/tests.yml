name: tests

on:
  push:
    branches:
      - main
  pull_request: null

concurrency:
  group: tests
  cancel-in-progress: false

jobs:
  tests-lock:
    name: test updates
    runs-on: "ubuntu-latest"
    if: github.event.pull_request.title != 'relock w/ conda-lock'
    steps:
      - uses: actions/checkout@v4

      - name: relock
        id: relock
        uses: ./
        with:
          environment-file: test-env.yml
          lock-file: conda-lock.yml
          ignored-packages: ''
          relock-all-packages: false
          github-token: ${{ secrets.GH_PAT }}
          automerge: false
          base-branch: ${{ github.head_ref }}

      - name: did it relock?
        if: steps.relock.outputs.relocked != 'true'
        run: exit 1

      - name: test that PR is OK
        if: steps.relock.outputs.relocked == 'true'
        shell: bash
        run: |
          gh pr checkout ${{ steps.relock.outputs.pull-request-number }}
          ls -lah
          if [ -f conda-lock.yml ]; then
            :  # do nothing
          else
            echo "conda-lock.yml not found"
            exit 1
          fi
          grep numpy conda-lock.yml
          grep python conda-lock.yml
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: close PR
        if: always()
        continue-on-error: true
        shell: bash
        run: gh pr close ${{ steps.relock.outputs.pull-request-number }}
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

  tests-no-lock:
    name: test no update
    needs: tests-lock
    runs-on: "ubuntu-latest"
    if: github.event.pull_request.title != 'relock w/ conda-lock'
    steps:
      - uses: actions/checkout@v4

      - uses: conda-incubator/setup-miniconda@v3
        with:
          python-version: 3.11
          channels: conda-forge
          channel-priority: strict
          show-channel-urls: true
          miniforge-version: latest

      - name: make the lock file
        shell: bash -leo pipefail {0}
        run: |
          conda install --yes conda-lock
          conda-lock lock --file test-env.yml --lockfile conda-lockk.yml

      - name: relock
        id: relock
        uses: ./
        with:
          environment-file: test-env.yml
          lock-file: conda-lockk.yml
          ignored-packages: ''
          relock-all-packages: false
          github-token: ${{ secrets.GH_PAT }}
          automerge: false
          base-branch: ${{ github.head_ref }}

      - name: did it not relock?
        if: steps.relock.outputs.relocked == 'true'
        run: exit 1

      - name: close PR
        if: always()
        continue-on-error: true
        shell: bash
        run: gh pr close ${{ steps.relock.outputs.pull-request-number }}
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

  tests-skip-existing-part-1:
    name: test updates
    needs: tests-no-lock
    outputs:
      pull-request-number: ${{ steps.relock.outputs.pull-request-number }}
    runs-on: "ubuntu-latest"
    steps:
      - uses: actions/checkout@v4

      - name: relock
        id: relock
        uses: ./
        with:
          environment-file: test-env.yml
          lock-file: conda-lock.yml
          ignored-packages: ''
          relock-all-packages: false
          github-token: ${{ secrets.GH_PAT }}
          automerge: false
          base-branch: ${{ github.head_ref }}

      - name: did it relock?
        if: steps.relock.outputs.relocked != 'true'
        run: exit 1

      - name: test that PR is OK
        if: steps.relock.outputs.relocked == 'true'
        shell: bash
        run: |
          gh pr checkout ${{ steps.relock.outputs.pull-request-number }}
          ls -lah
          if [ -f conda-lock.yml ]; then
            :  # do nothing
          else
            echo "conda-lock.yml not found"
            exit 1
          fi
          grep numpy conda-lock.yml
          grep python conda-lock.yml
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

  tests-skip-existing-part-2:
    name: test updates
    needs: tests-skip-existing-part-1
    runs-on: "ubuntu-latest"
    steps:
      - uses: actions/checkout@v4

      - name: relock
        id: relock
        uses: ./
        with:
          environment-file: test-env.yml
          lock-file: conda-lock.yml
          ignored-packages: ''
          relock-all-packages: false
          github-token: ${{ secrets.GH_PAT }}
          automerge: false
          base-branch: ${{ github.head_ref }}
          skip-if-pr-exists: true

      - name: did it relock?
        if: steps.relock.outputs.relocked == 'true'
        run: exit 1

      - name: close PR
        if: always()
        continue-on-error: true
        shell: bash
        run: gh pr close ${{ needs.tests-skip-existing-part-1.outputs.pull-request-number }}
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

